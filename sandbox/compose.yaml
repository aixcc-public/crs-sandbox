######################################
# COMPETITORS: DO NOT MODIFY THIS FILE
######################################

services:
  test: 
    profiles: 
      - test
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # These values will be modified automatically at competition time
      - DOCKER_HOST=tcp://dind:2375 
      - AIXCC_LITELLM_HOSTNAME=http://litellm
      - AIXCC_API_HOSTNAME=http://iapi"
      - AIXCC_CP_ROOT=/cp_root
      - AIXCC_CRS_SCRATCH_SPACE=/crs_scratch
      - LITELLM_KEY=sk-1234
    depends_on:
      litellm:
        condition: service_healthy
      iapi:
        condition: service_healthy
  dind: 
    profiles:
      - development
      - competition
      - test
    image: docker:24-dind
    command: [ "dockerd", "-H", "tcp://0.0.0.0:2375", "--tls=false", "--storage-driver=overlay2" ]
    restart: always
    privileged: true # This must run with privlege to support nested virtualization within the public Linux CP for `virtme-ng`
    ports:
      - "2375:2375"
    environment:
      - DOCKER_TLS_CERTDIR # intentionally blank to optimize runtime
    volumes:
      - type: bind 
        source: ${PWD}/crs_scratch
        target: /crs_scratch
        bind:
          propagation: rshared
  iapi:
    profiles:
      - development
      - competition
      - test
    image: ghcr.io/aixcc-sc/iapi:v3.0.0
    restart: always
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD-SHELL", "wget -O /dev/null http://localhost || exit 1"]
      timeout: 10s
    environment:
      - AIXCC_API_HOSTNAME=https://api.game-services.aixcc.tech
  db:
    profiles:
      - development
      - test
    image: postgres:16.2-alpine3.19
    restart: always
    shm_size: 128mb
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=aixcc
      - POSTGRES_USER=aixcc
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=litellm
  litellm:
    profiles:
      - development
      - test
    image: ghcr.io/berriai/litellm-database:main-v1.35.10
    restart: always
    configs:
      - source: litellm_config
        target: /app/config.yaml
      - source: litellm_vertex_config
        target: /vertex_key.json
    command: [ "--config", "/app/config.yaml", "--port", "80", "--num_workers", "8" ]
    ports:
      - "8081:80"
    env_file: env
    environment:
      - DATABASE_URL=postgresql://aixcc:aixcc@db
    healthcheck:
      test: ["CMD-SHELL", "python3", "--version"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 1s

configs:
  litellm_config:
    file: ./litellm/local_litellm_config.yaml
  litellm_vertex_config:
    file: ./litellm/vertex_key.json

