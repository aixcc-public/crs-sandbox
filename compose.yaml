######################################################################################################
# DO NOT MODIFY THIS FILE ANYWHERE OTHER THAN WITHIN THE CUSTOMIZE BLOCKS
#
#
# New services are acceptable
# Any service which needs KVM or Docker MUST run privleged and pass the appropriate volume (see below)
# /dev/kvm for QEMU or /var/run/docker.sock for Docker
#
# Profiles
# We use the profiles "development" and "competition"
# All containers added by competitors must include the appropriate profiles
# At competition time only the `--profile competition` will be used
# This will cause the LiteLLM proxy to disappear.
# Competitors should be using the AIXCC_LITELLM_HOSTNAME environment variable
# for accessing LiteLLM, so we can swap the URL at competition time.
#
######################################################################################################

include:
  - sandbox/compose.yaml

#############
### CUSTOMIZE
#############


### Additional services are welcomed, just make sure to use the supplied variables and profile names
services:
  crs:
    profiles:
      - development
      - competition
      - test
    build:
      context: . # Note that this uses the base folder for context, you may not need this for your CRS
      dockerfile: crs/src/Dockerfile
    volumes:
      #################################################################################
      ### THESE VOLUMES MUST BE INCLUDED WITHOUT MODIFICATION TO ALL CRS CONTAINERS ### 
      # `/cp_root` is the core CP mount point where repos are attached as subdirectories.
      # A CRS must automatically copy subdirectories from `/cp_root` to some location within `/crs_scratch` for building and should not modify settings within this section.
      - type: bind
        source: ./cp_root
        target: /cp_root
        read_only: true
      - type: volume
        source: crs_scratch 
        target: /crs_scratch
        read_only: false 
      #################################################################################
      
    environment:
      # These values will be modified automatically at competition time
      - DOCKER_HOST="tcp://dind:2376" 
      - AIXCC_LITELLM_HOSTNAME="http://litellm"
      - AIXCC_API_HOSTNAME="http://iapi"
      - AIXCC_CP_ROOT="/cp_root"
      - LITELLM_KEY="sk-1234"
    depends_on:
      litellm:
        condition: service_healthy
      iapi:
        condition: service_started

#############
### CUSTOMIZE
#############
